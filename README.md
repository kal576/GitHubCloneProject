This is a combined version from both branches.
